<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faculty Toolkit ‚Äî AI-Powered Text Analysis</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }
    
    .content {
      padding: 30px;
    }
    
    .input-section {
      margin-bottom: 30px;
    }
    
    textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.3s;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      min-width: 150px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #e0e0e0;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .stats-btn {
      background: #4caf50;
      color: white;
    }
    
    .stats-btn:hover {
      background: #45a049;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #667eea;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .output-section {
      margin-top: 30px;
    }
    
    .output-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }
    
    .output-card h3 {
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .output-card pre {
      background: white;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .sentiment-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .sentiment-positive {
      background: #4caf50;
      color: white;
    }
    
    .sentiment-negative {
      background: #f44336;
      color: white;
    }
    
    .keyword-tag {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      margin: 5px;
      font-size: 14px;
    }
    
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-card h4 {
      font-size: 2em;
      margin-bottom: 5px;
    }
    
    .stat-card p {
      opacity: 0.9;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #c62828;
      margin-bottom: 20px;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéì Faculty Toolkit</h1>
      <p>AI-Powered Text Analysis for Academic Feedback</p>
    </div>
    
    <div class="content">
      <div class="input-section">
        <textarea id="input" placeholder="Paste course notes, student feedback, or any text here..."></textarea>
        
        <div class="button-group">
          <button class="btn-primary" onclick="runAnalyzeAll()">üöÄ Analyze All</button>
          <button class="btn-secondary" onclick="runSummarize()">üìù Summarize</button>
          <button class="btn-secondary" onclick="runAnalyze()">üîë Keywords</button>
          <button class="btn-secondary" onclick="runPredict()">üòä Sentiment</button>
          <button class="stats-btn" onclick="showStats()">üìä Statistics</button>
          <button class="btn-secondary" onclick="resetStats()">‚ôªÔ∏è Reset Stats</button>
          <button class="btn-secondary" onclick="visualizeData()">üìà Visualize</button>
          <button class="btn-secondary" onclick="downloadCSV()">üì• Download CSV</button>
          <button class="btn-secondary" onclick="clearAll()">üóëÔ∏è Clear</button>
        </div>
      </div>
      
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing your text...</p>
      </div>
      
      <div id="error-container"></div>
      
      <div class="output-section" id="output-section"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API = "http://127.0.0.1:8000";
    const chartInstances = [];

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('output-section').innerHTML = '';
      document.getElementById('error-container').innerHTML = '';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function showError(message) {
      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = `<div class="error">‚ùå ${message}</div>`;
    }

    function formatOutput(data, type) {
      const outputSection = document.getElementById('output-section');
      let html = '';

      if (type === 'analyze-all') {
        html = `
          <div class="output-card">
            <h3>üìä Complete Analysis</h3>
            <div>
              <p><strong>Text Statistics:</strong> ${data.word_count} words, ${data.text_length} characters</p>
            </div>
          </div>
          <div class="output-card">
            <h3>üìù Summary</h3>
            <p>${data.summary}</p>
          </div>
          <div class="output-card">
            <h3>üòä Sentiment</h3>
            <p>
              <span class="sentiment-badge sentiment-${data.sentiment.label.toLowerCase()}">
                ${data.sentiment.label}
              </span>
              <span style="margin-left: 10px;">Confidence: ${(data.sentiment.score * 100).toFixed(1)}%</span>
            </p>
          </div>
          <div class="output-card">
            <h3>üîë Keywords (${data.unique_terms} unique terms)</h3>
            <div>
              ${data.keywords.map(k => `<span class="keyword-tag">${k.term} (${k.count})</span>`).join('')}
            </div>
          </div>
        `;
      } else if (type === 'summarize') {
        html = `<div class="output-card">
          <h3>üìù Summary</h3>
          <p>${data.summary}</p>
        </div>`;
      } else if (type === 'analyze') {
        html = `<div class="output-card">
          <h3>üîë Keywords (${data.unique_terms} unique terms)</h3>
          <div>
            ${data.keywords.map(k => `<span class="keyword-tag">${k.term} (${k.count})</span>`).join('')}
          </div>
        </div>`;
      } else if (type === 'predict') {
        html = `<div class="output-card">
          <h3>üòä Sentiment Analysis</h3>
          <p>
            <span class="sentiment-badge sentiment-${data.label.toLowerCase()}">
              ${data.label}
            </span>
            <span style="margin-left: 10px;">Confidence: ${(data.score * 100).toFixed(1)}%</span>
          </p>
        </div>`;
      } else if (type === 'stats') {
        html = `
          <div class="stats-panel">
            <div class="stat-card">
              <h4>${data.total_requests}</h4>
              <p>Total Requests</p>
            </div>
            <div class="stat-card">
              <h4>${data.recent_requests_24h}</h4>
              <p>Last 24 Hours</p>
            </div>
            <div class="stat-card">
              <h4>${data.sentiment_distribution.positive}</h4>
              <p>Positive</p>
            </div>
            <div class="stat-card">
              <h4>${data.sentiment_distribution.negative}</h4>
              <p>Negative</p>
            </div>
          </div>
          <div class="output-card">
            <h3>üìä Usage by Endpoint</h3>
            <pre>${JSON.stringify(data.by_endpoint, null, 2)}</pre>
          </div>
        `;
      }

      outputSection.innerHTML = html;
    }

    async function runAnalyzeAll() {
      const text = document.getElementById("input").value.trim();
      if (!text) {
        showError("Please enter some text to analyze");
        return;
      }

      showLoading();
      try {
        const res = await fetch(`${API}/analyze-all`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const data = await res.json();
        if (res.ok) {
          formatOutput(data, 'analyze-all');
        } else {
          showError(data.detail || "An error occurred");
        }
      } catch (error) {
        showError(`Network error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    async function runSummarize() {
      const text = document.getElementById("input").value.trim();
      if (!text) {
        showError("Please enter some text to summarize");
        return;
      }

      showLoading();
      try {
        const res = await fetch(`${API}/summarize`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const data = await res.json();
        if (res.ok) {
          formatOutput(data, 'summarize');
        } else {
          showError(data.detail || "An error occurred");
        }
      } catch (error) {
        showError(`Network error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    async function runAnalyze() {
      const text = document.getElementById("input").value.trim();
      if (!text) {
        showError("Please enter some text to analyze");
        return;
      }

      showLoading();
      try {
        const res = await fetch(`${API}/analyze`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const data = await res.json();
        if (res.ok) {
          formatOutput(data, 'analyze');
        } else {
          showError(data.detail || "An error occurred");
        }
      } catch (error) {
        showError(`Network error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    async function runPredict() {
      const text = document.getElementById("input").value.trim();
      if (!text) {
        showError("Please enter some text to analyze");
        return;
      }

      showLoading();
      try {
        const res = await fetch(`${API}/predict`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const data = await res.json();
        if (res.ok) {
          formatOutput(data, 'predict');
        } else {
          showError(data.detail || "An error occurred");
        }
      } catch (error) {
        showError(`Network error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    async function showStats() {
      showLoading();
      try {
        const res = await fetch(`${API}/stats`);
        const data = await res.json();
        if (res.ok) {
          formatOutput(data, 'stats');
        } else {
          showError(data.detail || "An error occurred");
        }
      } catch (error) {
        showError(`Network error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    function clearAll() {
      document.getElementById("input").value = '';
      document.getElementById("output-section").innerHTML = '';
      document.getElementById("error-container").innerHTML = '';
    }

    function downloadCSV() {
      window.open(`${API}/export-csv`, '_blank');
    }

async function resetStats() {
  const confirmed = confirm("This will clear all logged usage data and reset the statistics dashboard. Continue?");
  if (!confirmed) return;

  showLoading();
  try {
    const res = await fetch(`${API}/reset-stats`, { method: "POST" });
    const data = await res.json();
    if (res.ok) {
      formatOutput({
        total_requests: 0,
        recent_requests_24h: 0,
        sentiment_distribution: { positive: 0, negative: 0 },
        by_endpoint: {}
      }, 'stats');
    } else {
      showError(data.detail || "Unable to reset stats");
    }
  } catch (error) {
    showError(`Network error: ${error.message}`);
  } finally {
    hideLoading();
  }
}

    function destroyCharts() {
      while (chartInstances.length) {
        const chart = chartInstances.pop();
        chart.destroy();
      }
    }

    function renderVisualization(data) {
      const outputSection = document.getElementById('output-section');

      if (!data.total_records) {
        outputSection.innerHTML = `
          <div class="output-card">
            <h3>üìà Visualization</h3>
            <p>No analysis data yet. Run an analysis to build insights.</p>
          </div>
        `;
        destroyCharts();
        return;
      }

      const hasWordCounts = data.daily_word_counts && data.daily_word_counts.length;
      const hasKeywords = data.top_keywords && data.top_keywords.length;
      const hasSentimentSeries = data.sentiment_series && data.sentiment_series.length;

      outputSection.innerHTML = `
        <div class="output-card">
          <h3>üìà Analysis Overview</h3>
          <p>Total Records: <strong>${data.total_records}</strong></p>
          ${data.date_range ? `<p>Coverage: ${data.date_range.start} ‚Üí ${data.date_range.end}</p>` : ''}
        </div>
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Endpoint Usage</h3>
            <canvas id="endpointChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Sentiment Distribution</h3>
            <canvas id="sentimentChart"></canvas>
          </div>
          ${hasWordCounts ? `
            <div class="chart-card">
              <h3>Average Word Count by Day</h3>
              <canvas id="wordCountChart"></canvas>
            </div>` : ''}
          ${hasKeywords ? `
            <div class="chart-card">
              <h3>Top Keywords</h3>
              <canvas id="keywordsChart"></canvas>
            </div>` : ''}
          ${hasSentimentSeries ? `
            <div class="chart-card" style="grid-column: 1 / -1;">
              <h3>Sentiment Per Student</h3>
              <canvas id="sentimentSeriesChart"></canvas>
            </div>` : ''}
        </div>
      `;

      destroyCharts();

      const endpointLabels = Object.keys(data.endpoint_counts || {});
      const endpointValues = endpointLabels.map(label => data.endpoint_counts[label]);
      const endpointCtx = document.getElementById('endpointChart').getContext('2d');
      chartInstances.push(new Chart(endpointCtx, {
        type: 'bar',
        data: {
          labels: endpointLabels,
          datasets: [{
            label: 'Requests',
            data: endpointValues,
            backgroundColor: '#667eea'
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      }));

      const sentimentLabels = Object.keys(data.sentiment_counts || {});
      const sentimentValues = sentimentLabels.map(label => data.sentiment_counts[label]);
      const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
      chartInstances.push(new Chart(sentimentCtx, {
        type: 'doughnut',
        data: {
          labels: sentimentLabels,
          datasets: [{
            data: sentimentValues,
            backgroundColor: ['#4caf50', '#f44336', '#ffc107', '#90a4ae']
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      }));

      if (hasWordCounts) {
        const wordCtx = document.getElementById('wordCountChart').getContext('2d');
        const wordLabels = data.daily_word_counts.map(entry => entry.date);
        const wordValues = data.daily_word_counts.map(entry => entry.avg_word_count);
        chartInstances.push(new Chart(wordCtx, {
          type: 'line',
          data: {
            labels: wordLabels,
            datasets: [{
              label: 'Avg Word Count',
              data: wordValues,
              borderColor: '#764ba2',
              backgroundColor: 'rgba(118, 75, 162, 0.15)',
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true }
            },
            plugins: {
              legend: { display: false }
            }
          }
        }));
      }

      if (hasKeywords) {
        const keywordCtx = document.getElementById('keywordsChart').getContext('2d');
        const keywordLabels = data.top_keywords.map(item => item.term);
        const keywordValues = data.top_keywords.map(item => item.count);
        chartInstances.push(new Chart(keywordCtx, {
          type: 'bar',
          data: {
            labels: keywordLabels,
            datasets: [{
              label: 'Occurrences',
              data: keywordValues,
              backgroundColor: '#2196f3'
            }]
          },
          options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        }));
      }

      if (hasSentimentSeries) {
        const sentimentSeriesCtx = document.getElementById('sentimentSeriesChart').getContext('2d');
        const seriesData = data.sentiment_series.map(entry => ({
          x: entry.sequence,
          y: entry.label === 'POSITIVE' ? 1 : entry.label === 'NEGATIVE' ? -1 : 0,
          sentiment: entry.label,
          score: entry.score,
          timestamp: entry.timestamp || `Entry ${entry.sequence}`
        }));
        chartInstances.push(new Chart(sentimentSeriesCtx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Sentiment by Student',
              data: seriesData,
              pointBackgroundColor: seriesData.map(item => item.sentiment === 'POSITIVE' ? '#4caf50' : '#f44336'),
              pointRadius: 6
            }]
          },
          options: {
            scales: {
              x: {
                title: { display: true, text: 'Student # (sequence)' },
                ticks: { precision: 0 }
              },
              y: {
                min: -1.5,
                max: 1.5,
                title: { display: true, text: 'Sentiment' },
                ticks: {
                  stepSize: 1,
                  callback: (value) => {
                    if (value === 1) return 'Positive';
              
                    if (value === -1) return 'Negative';
                    return '';
                  }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const point = context.raw;
                    const sentiment = point.sentiment;
                    const score = (point.score * 100).toFixed(1);
                    return `#${point.x}: ${sentiment} (${score}%)`;
                  }
                }
              },
              legend: { display: false }
            }
          }
        }));
      }
    }

    async function visualizeData() {
      showLoading();
      try {
        const res = await fetch(`${API}/visualize-data`);
        const data = await res.json();
        if (res.ok) {
          renderVisualization(data);
        } else {
          showError(data.detail || "Unable to build visualization");
        }
      } catch (error) {
        showError(`Network error: ${error.message}`);
      } finally {
        hideLoading();
      }
    }
  </script>
</body>
</html>
